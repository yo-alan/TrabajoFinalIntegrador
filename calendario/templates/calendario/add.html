{% extends "admin/base.html" %}

{% block title %}Crear un calendario a medida {% endblock %}

{% block article %}
	<script>
		function allowDrop(ev) {
			ev.preventDefault();
		}
		
		function drag(ev) {
			ev.dataTransfer.setData("text", ev.target.id);
		}
		
		function drop(ev) {
			ev.preventDefault();
			var especialidadId = ev.dataTransfer.getData("text");
			var especialidad = document.getElementById(especialidadId);
			
			if(especialidad == null)
				return;
			
			if(ev.target.nodeName == 'STRONG' && especialidad.parentNode.nodeName != 'LI'){
				
				var especialidadDestino = ev.target.parentNode;
				var divDestino = especialidadDestino.parentNode;
				var divOrigen = especialidad.parentNode;
				
				divDestino.appendChild(especialidad);
				divOrigen.appendChild(especialidadDestino);
				
			}
			else if(ev.target.children.length == 0){
				
				if(ev.target.nodeName == 'STRONG')
					return;
				
				especialidad = especialidad.cloneNode(true);
				
				//PARA ASIGNAR UN ID HAY QUE COMPROBAR SU UBICACION.
				especialidad.setAttribute('id', parseInt(ev.target.getAttribute("horario"))*{{ entorno.espacio.dias_habiles|length }}+parseInt(ev.target.getAttribute("dia")));
				especialidad.setAttribute('desde', ev.target.getAttribute('desde'));
				especialidad.setAttribute('dia', ev.target.getAttribute('dia'));
				
				ev.target.appendChild(especialidad);
			}
			
		}
		
		function guardar(){
			alert("Guardando...");
			var calendario = {};
			for(i = 0; i < {{ entorno.espacio.dias_habiles|length }}*{{ entorno.espacio.horas|length }}; i++){
				//~ calendario.
				
			}
			calendario.csrfmiddlewaretoken = "{{ csrf_token }}";
			$.ajax({
				url: "/calendario/add",
				type: 'POST',
				data: calendario,
				success: function(response){
					
					
					
				}
			});
		}
		
		function imprimir(){
			alert("Imprimiendo...");
		}
		
		function eliminar(ev){
			var especialidadId = ev.dataTransfer.getData("text");
			var especialidad = document.getElementById(especialidadId);
			
			if(especialidad == null)
				return;
			
			var nodePadre = especialidad.parentNode;
			
			if(nodePadre.nodeName == 'DIV')
				nodePadre.removeChild(especialidad);
		}
		
		function nuevo(){
			location.reload();
		}
	</script>
	<div class="container-fluid">
		<div class="row clearfix">
			<div class="col-md-12">
				<h3 class="text-center">
					Titulo
				</h3>
				<ul class="list-inline">
					<li>
						<img class="btn" src="/static/calendario/images/new.png" onclick="nuevo();" title="Nuevo calendario...">
					</li>
					<li>
						<img class="btn" src="/static/calendario/images/save.png" onclick="guardar();" title="Guardar calendario...">
					</li>
					<li>
						<img class="btn" src="/static/calendario/images/print.png" onclick="imprimir();" title="Imprimir calendario...">
					</li>
					<li>
						<img src="/static/calendario/images/trash.png" id="trash" ondrop="eliminar(event)" ondragover="allowDrop(event)">
					</li>
				</ul>
				<div class="col-md-8 pull-left">
					<table class="table table-bordered">
						<thead>
							<tr class="bg-primary">
								<th class="text-center">
								</th>
								{% for dia in dias %}
									<th class="text-center">
										<h4><strong>{{ dia }}</strong></h4>
									</th>
								{% endfor %}
							</tr>
						</thead>
						<tbody>
							{% for hora in entorno.espacio.horas %}
								<tr>
									<td class="text-center bg-primary">
										<h4>
											<strong>{{ hora.hora_desde }}</strong>
										</h4>
										<h4>
											<strong>{{ hora.hora_hasta }}</strong>
										</h4>
									</td>
									{% for dia in entorno.espacio.dias_habiles %}
										<td class="text-center active">
											<div id="{{ hora }}{{ dia }}" dia="{{ dia }}" desde="{{ hora }}" horario="{{ forloop.parentloop.counter0 }}"ondrop="drop(event)" ondragover="allowDrop(event)" class="horario-container">
												
											</div>
										</td>
									{% endfor %}
								</tr>
							{% endfor %}
						</tbody>
					</table>
				</div>
				<div class="col-md-2 pull-right">
					<ul class="list-unstyled">
						{% for profesional in entorno.profesionales %}
							<li>
								<p id="{{ profesional.especialidad.nombre }}" name="{{ profesional.especialidad.id }}" draggable="true" ondragstart="drag(event)" class="img-rounded lead especialidad text-center" style="background-color:{{ colores.2 }}">
									<strong>{{ profesional.especialidad }}</strong>
								</p>
							</li>
						{% endfor %}
					</ul>
				</div>
			</div>
		</div>
	</div>
{% endblock %}
